



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.3">
    
    
      
        <title>Advanced Usage - Pypeln</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.adb8469c.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#advanced-usage" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Pypeln" aria-label="Pypeln" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Pypeln
            </span>
            <span class="md-header-nav__topic">
              
                Advanced Usage
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/cgarciae/pypeln/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    cgarciae/pypeln
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Pypeln" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Pypeln
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/cgarciae/pypeln/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    cgarciae/pypeln
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Advanced Usage
      </label>
    
    <a href="./" title="Advanced Usage" class="md-nav__link md-nav__link--active">
      Advanced Usage
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    Architecture
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stage-types" class="md-nav__link">
    Stage Types
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stages" class="md-nav__link">
    Stages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workers" class="md-nav__link">
    Workers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#queues" class="md-nav__link">
    Queues
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resource-management" class="md-nav__link">
    Resource Management
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asyncio-integration" class="md-nav__link">
    Asyncio Integration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#await" class="md-nav__link">
    await
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#async-for" class="md-nav__link">
    async for
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-loop" class="md-nav__link">
    Event Loop
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pipe-operator" class="md-nav__link">
    Pipe Operator
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      API Reference
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        API Reference
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../api/process/" title="process" class="md-nav__link">
      process
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/thread/" title="thread" class="md-nav__link">
      thread
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/task/" title="task" class="md-nav__link">
      task
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    Architecture
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stage-types" class="md-nav__link">
    Stage Types
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stages" class="md-nav__link">
    Stages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workers" class="md-nav__link">
    Workers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#queues" class="md-nav__link">
    Queues
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resource-management" class="md-nav__link">
    Resource Management
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asyncio-integration" class="md-nav__link">
    Asyncio Integration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#await" class="md-nav__link">
    await
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#async-for" class="md-nav__link">
    async for
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-loop" class="md-nav__link">
    Event Loop
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pipe-operator" class="md-nav__link">
    Pipe Operator
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/cgarciae/pypeln/edit/master/docs/advanced.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="advanced-usage">Advanced Usage<a class="headerlink" href="#advanced-usage" title="Permanent link">&para;</a></h1>
<h2 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">&para;</a></h2>
<p>A Pypeln pipeline has the following structure:</p>
<p><img alt="diagram" src="https://github.com/cgarciae/pypeln/blob/master/docs/images/diagram.png?raw=true" /></p>
<ul>
<li>Its composed of several concurrent <strong>stages</strong></li>
<li>At each stage it contains on or more <strong>worker</strong> entities that perform a task.</li>
<li>Related stages are connected by a <strong>queue</strong>, workers from one stage <em>put</em> items into it, and workers from the other stage <em>get</em> items from it.</li>
<li>Source stages consume iterables.</li>
<li>Sink stages can be converted into iterables which 
consume them.</li>
</ul>
<h3 id="stage-types">Stage Types<a class="headerlink" href="#stage-types" title="Permanent link">&para;</a></h3>
<p>Pypeln has 3 types of stages, each stage has an associated worker and queue types: </p>
<table>
<thead>
<tr>
<th>Stage Type</th>
<th>Worker</th>
<th>Queue</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pl.process.Stage</code></td>
<td><code>multiprocessing.Process</code></td>
<td><code>multiprocessing.Queue</code></td>
</tr>
<tr>
<td><code>pl.thread.Stage</code></td>
<td><code>threading.Thread</code></td>
<td><code>queue.Queue</code></td>
</tr>
<tr>
<td><code>pl.task.Stage</code></td>
<td><code>asyncio.Task</code></td>
<td><code>asyncio.Queue</code></td>
</tr>
</tbody>
</table>
<p>Depending on the type of stage you use the following characteristics will vary: memory management, concurrency, parallelism, inter-stage communication overhead, worker initialization overhead:</p>
<hr />
<table>
<thead>
<tr>
<th>Stage Type</th>
<th>Memory</th>
<th>Concurrency</th>
<th>Parallelism</th>
<th>Communication Overhead</th>
<th>Initialization Overhead</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>process</code></td>
<td>independent</td>
<td>cpu + IO</td>
<td>cpu + IO</td>
<td>high</td>
<td>high</td>
</tr>
<tr>
<td><code>thread</code></td>
<td>shared</td>
<td>only for IO</td>
<td>only for IO</td>
<td>none</td>
<td>mid</td>
</tr>
<tr>
<td><code>task</code></td>
<td>shared</td>
<td>optimized IO</td>
<td>optimized IO</td>
<td>none</td>
<td>low</td>
</tr>
</tbody>
</table>
<h2 id="stages">Stages<a class="headerlink" href="#stages" title="Permanent link">&para;</a></h2>
<p>Stages are lazy <a href="https://docs.python.org/3/glossary.html#term-iterable">iterable</a> objects that only contain meta information about the computation, to actually execute a pipeline you can iterate over it using a for loop, calling <code>list</code>, <code>pl.&lt;module&gt;.run</code>, etc. For example:</p>
<p><div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">pypeln</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span>

<span class="k">def</span> <span class="nf">slow_add1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="p">())</span> <span class="c1"># &lt;= some slow computation</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">data</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># [0, 1, 2, ..., 9]</span>
<span class="n">stage</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">slow_add1</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stage</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># e.g. 2, 1, 5, 6, 3, 4, 7, 8, 9, 10</span>
</code></pre></div>
This example uses <code>pl.process</code> but it works the same for all the other modules. Since <code>pypeln</code> implements the <code>Iterable</code> interface it becomes very intuitive to use and compatible with most other python code. </p>
<h2 id="workers">Workers<a class="headerlink" href="#workers" title="Permanent link">&para;</a></h2>
<p>Each Stage defines a number of workers which can usually be controlled by the <code>workers</code> parameter on <code>pypeln</code>'s various functions. In general try not to create more workers than the number of cores you have on your machine or else they will end up fighting for resources, but this varies with the type of worker. The following table shows the relative cost in memory + cpu usage of creating each worker:</p>
<table>
<thead>
<tr>
<th>Worker</th>
<th>Memory + CPU Cost</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Process</code></td>
<td>high</td>
</tr>
<tr>
<td><code>Thread</code></td>
<td>mid</td>
</tr>
<tr>
<td><code>Task</code></td>
<td>low</td>
</tr>
</tbody>
</table>
<p>General guidelines:</p>
<ul>
<li>Only use <code>processes</code> when you need to perform heavy CPU operations in pararallel such as image processing, data transformations, etc. When forking a <code>Process</code> all the memory is copied to the new process, intialization is slow, communications between processes is costly since python objects have to be serialized, but you effectly escape the GIL so you gain true parallelism.</li>
<li><code>Threads</code> are very good for doing syncronous IO tasks such as interacting with the OS and libraries that yet don't expose a <code>async</code> API.</li>
<li><code>Tasks</code> are highly optimized for asynchronous IO operations, they are super cheap to create since they are just regular python objects, and you can generally create them in higher quantities since the event loop manages them efficiently for you. </li>
</ul>
<h2 id="queues">Queues<a class="headerlink" href="#queues" title="Permanent link">&para;</a></h2>
<p>Worker communicate between each other through <code>Queues</code>. The maximum number of elements each <code>Queue</code> can hold is controlled by the <code>maxsize</code> parameter in <code>pypeln</code>'s various functions. By default this number is <code>0</code> which means there is no limit to the number of elements, however when <code>maxsize</code> is set it serves as a <a href="https://www.quora.com/What-is-backpressure-in-the-context-of-data-streaming">backpressure</a> mechanism that prevents previous stages from pushing new elements to a Queue when it becomes full (reaches its <code>maxsize</code>), these stages will stop their computation until space becomes available thus potentially preveting <code>OutOfMemeory</code> errors on the slower stages.</p>
<p>The following table shows the relative communication cost between workers given the nature of their queues:</p>
<table>
<thead>
<tr>
<th>Worker</th>
<th>Communication Cost</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Process</code></td>
<td>high</td>
</tr>
<tr>
<td><code>Thread</code></td>
<td>none</td>
</tr>
<tr>
<td><code>Task</code></td>
<td>none</td>
</tr>
</tbody>
</table>
<p>General guidelines:</p>
<ul>
<li>Communication between <code>processes</code> is costly since python objects have to be serialized, which has a considerable overhead when passing large objects such as <code>numpy</code> arrays, binary objects, etc. To avoid this overhead try only passing metadata information such as filepaths between processes.</li>
<li>There is no overhead in communication between <code>threads</code> or <code>tasks</code>, since everything happens in-memory there is no serialization overhead.</li>
</ul>
<h2 id="resource-management">Resource Management<a class="headerlink" href="#resource-management" title="Permanent link">&para;</a></h2>
<p>There are many occasions where you need to create some resource objects (e.g. http or database sessions) that (for efficiency) are expected to last the whole span of each worker's life. To support and effectily manage the lifecycle of such objects most of <code>pypeln</code>s functions accept the <code>on_start</code> and <code>on_done</code> callbacks.</p>
<p>When a worker is created its <code>on_start</code> function get called. This function can return a dictionary containing these resource objects which will be passed as keyword arguments to the workers main function and the <code>on_end</code> function. For exmaple:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">pypeln</span> <span class="k">as</span> <span class="nn">pl</span>

<span class="k">def</span> <span class="nf">on_start</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">http_session</span> <span class="o">=</span> <span class="n">get_http_session</span><span class="p">(),</span> 
        <span class="n">db_session</span> <span class="o">=</span> <span class="n">get_db_session</span><span class="p">(),</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">http_session</span><span class="p">,</span> <span class="n">db_session</span><span class="p">):</span>
    <span class="c1"># some logic</span>
    <span class="k">return</span> <span class="n">y</span>

<span class="k">def</span> <span class="nf">on_end</span><span class="p">(</span><span class="n">http_session</span><span class="p">,</span> <span class="n">db_session</span><span class="p">):</span>
    <span class="n">http_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">db_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="n">stage</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">on_start</span><span class="o">=</span><span class="n">on_start</span><span class="p">,</span> <span class="n">on_end</span><span class="o">=</span><span class="n">on_end</span><span class="p">)</span>
</code></pre></div>

<p>Additionally:</p>
<ul>
<li>If <code>f</code> defines a <code>worker_info</code> argument an object with information about the worker will be passed.</li>
<li>If <code>on_end</code> defines a <code>stage_status</code> an object with information about the stage will be passed. </li>
</ul>
<h2 id="asyncio-integration">Asyncio Integration<a class="headerlink" href="#asyncio-integration" title="Permanent link">&para;</a></h2>
<p>While you can consume <code>task</code> stages synchronously as you've seen, there are 2 ways to consume them using python <code>async</code> syntax:</p>
<h4 id="await">await<a class="headerlink" href="#await" title="Permanent link">&para;</a></h4>
<p>You can call <code>await</code> con any <code>task.Stage</code> to get back the results of its computation:</p>
<p><div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">pypeln</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">slow_add1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="p">())</span> <span class="c1"># &lt;= some slow computation</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">slow_gt3</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="p">())</span> <span class="c1"># &lt;= some slow computation</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">3</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># [0, 1, 2, ..., 9] </span>

    <span class="n">stage</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">slow_add1</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">stage</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">slow_gt3</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stage</span> <span class="c1"># e.g. [5, 6, 9, 4, 8, 10, 7]</span>
</code></pre></div>
When calling <code>await</code> on a stage you will get back the same result if you called <code>list</code> on it with be big difference that you wont block the current thread while waiting for the computation to materialize.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this example you are responsible for running the <code>main</code> task in the event loop yourself.</p>
</div>
<h4 id="async-for">async for<a class="headerlink" href="#async-for" title="Permanent link">&para;</a></h4>
<p><code>task</code> Stages are asynchronous generators so you can iterate through them using <code>async for</code> to get access each new element as soon as it become available:</p>
<p><div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">pypeln</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">slow_add1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="p">())</span> <span class="c1"># &lt;= some slow computation</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">slow_gt3</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="p">())</span> <span class="c1"># &lt;= some slow computation</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">3</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># [0, 1, 2, ..., 9] </span>

    <span class="n">stage</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">slow_add1</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">stage</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">slow_gt3</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">stage</span><span class="p">:</span>
        <span class="n">pritn</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="c1"># 5 6 9 4 8 10 7</span>
</code></pre></div>
When iterating a stage using <code>async for</code> you will get back the same result as if you called the normal <code>for</code> on it with be big difference that you wont block the current thread while waiting for the next element.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this example you are responsible for running the <code>main</code> task in the event loop yourself.</p>
</div>
<h3 id="event-loop">Event Loop<a class="headerlink" href="#event-loop" title="Permanent link">&para;</a></h3>
<p>When you run a <code>task</code> stage synchronously the tasks run on <code>pypeln</code>'s own event loop, however, if you itegrate them with other async code via <code>await</code> or <code>async for</code> these tasks will run on the current loop defined by <code>asyncio.get_event_loop()</code>.</p>
<h2 id="pipe-operator">Pipe Operator<a class="headerlink" href="#pipe-operator" title="Permanent link">&para;</a></h2>
<p>Most functions can return a <code>Partial</code> instead of a <code>Stage</code> if the <code>stage</code> argument is not given. These <code>Partial</code>s are callables that accept the missing <code>stage</code> parameter and call the computation. The following expressions are equivalent:</p>
<div class="codehilite"><pre><span></span><code>pl.process.map(f, stage, **kwargs) &lt;=&gt; pl.process.map(f, **kwargs)(stage)
</code></pre></div>


<p><code>Partial</code> implements the pipe <code>|</code> operator as</p>
<div class="codehilite"><pre><span></span><code>x | partial &lt;=&gt; partial(x)
</code></pre></div>


<p>This allows <code>pypeln</code> to enable you to define your pipelines more fluently:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pypenl</span> <span class="kn">import</span> <span class="n">process</span> <span class="k">as</span> <span class="n">pr</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">slow_add1</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">slow_gt3</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">|</span> <span class="nb">list</span>
<span class="p">)</span>
</code></pre></div>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href=".." title="Introduction" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Introduction
              </span>
            </div>
          </a>
        
        
          <a href="../api/process/" title="process" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                process
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/cgarciae" target="_blank" rel="noopener" title="github" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/cgarciae88" target="_blank" rel="noopener" title="twitter" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/in/cgarciae" target="_blank" rel="noopener" title="linkedin" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>